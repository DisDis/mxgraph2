<html>
<head>
	<script type="text/javascript">
		var DRAW_IFRAME_URL = 'https://www.draw.io/?gapi=0&db=0&embed=1';
		//var dav= '';
		// FIXME: Missing header in PUT reesponse with CORS
		/*
		Apache Configuration:
			
		DavLockDB /tmp/DavLock
			
		<Directory "/Library/WebServer/Documents/Webdav">
		  Options Indexes
		  DAV On
		  AuthType Basic
		  AuthName "Webdav"
		  AuthUserFile /etc/apache2/webdav.password
		  Header set Access-Control-Allow-Origin http://devhost.jgraph.com
		  Header set Access-Control-Allow-Credentials true
		  Header set Access-Control-Allow-Methods "POST, GET, PUT, DELETE, OPTIONS"
		  Header set Cache-Control "no-cache, no-store, must-revalidate"
		  Require valid-user
		</Directory>
		*/
		var dav = 'http://localhost/Webdav/';
		
		function edit(filename)
		{
			var req = new XMLHttpRequest();
			req.withCredentials = true;
			
			req.onreadystatechange = function()
			{
				if (req.readyState == 4)
				{
					var border = 0;
					var iframe = document.createElement('iframe');
					iframe.style.zIndex = '9999';
					iframe.style.position = 'absolute';
					iframe.style.top = border + 'px';
					iframe.style.left = border + 'px';
					 
					var resize = function()
					{
						iframe.setAttribute('width', document.body.clientWidth - 2 * border);
						iframe.setAttribute('height', document.body.clientHeight - 2 * border);
					};
					 
					if (border == 0)
					{
						iframe.setAttribute('frameborder', '0');
					}
		
					iframe.addEventListener('load', function()
					{
						iframe.contentWindow.postMessage(req.responseText, '*');
						resize();
					});
					 
					window.addEventListener('resize', resize);
					 
					var receive = function(evt)
					{
						if (evt.data.length > 0)
						{
							var req2 = new XMLHttpRequest();
							req2.withCredentials = true;
							
							req2.onreadystatechange = function()
							{
								if (req2.readyState == 4)
								{
									//console.log('req', req2.responseText);
								}
							};
							
							req2.open('PUT', dav + filename, true);
							req2.send(evt.data);
						}
						
						window.removeEventListener('resize', resize);
						window.removeEventListener('message', receive);
						document.body.removeChild(iframe);
					};
					
					window.addEventListener('message', receive);
					 
					resize();
					 
					iframe.setAttribute('src', DRAW_IFRAME_URL);
					document.body.appendChild(iframe);
				}
			};
			
			req.onerror = function()
			{
				alert('error');
			};

			req.open('GET', dav + filename, true);
			req.send();
		};
	</script>
</head>
<body>
	<input id="filename" type="text" value="test.xml"/>
	<button onclick="edit(document.getElementById('filename').value);">Edit</button>
</body>
</html>